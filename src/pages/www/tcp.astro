---
import WwwLayout from "../../layouts/WwwLayout.astro";
---

<WwwLayout title="TCP" subtitle="Transmission Control Protocol â€” reliable, ordered, connection-oriented transport" slug="tcp">
  <!-- TCP Header Structure -->
  <section class="section">
    <h2>TCP Header <span class="spec-label">RFC 9293</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 520 220" xmlns="http://www.w3.org/2000/svg">
        <!-- Bit markers -->
        <text x="40" y="12" text-anchor="middle" class="label">0</text>
        <text x="160" y="12" text-anchor="middle" class="label">15</text>
        <text x="280" y="12" text-anchor="middle" class="label">16</text>
        <text x="400" y="12" text-anchor="middle" class="label">31</text>

        <!-- Row 0: Source Port, Dest Port -->
        <rect x="40" y="20" width="120" height="30" class="filled" stroke-width="1"/>
        <text x="100" y="40" text-anchor="middle">Source Port</text>
        <rect x="160" y="20" width="120" height="30" class="filled" stroke-width="1"/>
        <text x="220" y="40" text-anchor="middle">Dest Port</text>
        <text x="280" y="55" text-anchor="start" class="label">16 bits each</text>

        <!-- Row 1: Sequence Number -->
        <rect x="40" y="55" width="240" height="30" class="filled" stroke-width="1"/>
        <text x="160" y="75" text-anchor="middle">Sequence Number</text>
        <text x="280" y="75" text-anchor="start" class="label">32 bits</text>

        <!-- Row 2: Acknowledgment Number -->
        <rect x="40" y="90" width="240" height="30" class="filled" stroke-width="1"/>
        <text x="160" y="110" text-anchor="middle">Acknowledgment Number</text>
        <text x="280" y="110" text-anchor="start" class="label">32 bits</text>

        <!-- Row 3: Data Offset, Reserved, Flags, Window -->
        <rect x="40" y="125" width="30" height="30" class="filled" stroke-width="1"/>
        <text x="55" y="145" text-anchor="middle" style="font-size:9px">Off</text>
        <rect x="70" y="125" width="20" height="30" class="filled" stroke-width="1"/>
        <text x="80" y="145" text-anchor="middle" style="font-size:8px">Rsv</text>
        <rect x="90" y="125" width="70" height="30" class="filled" stroke-width="1"/>
        <text x="125" y="145" text-anchor="middle">Flags</text>
        <rect x="160" y="125" width="120" height="30" class="filled" stroke-width="1"/>
        <text x="220" y="145" text-anchor="middle">Window Size</text>
        <text x="280" y="160" text-anchor="start" class="label">4 + 4 + 8 + 16 bits</text>

        <!-- Row 4: Checksum, Urgent Pointer -->
        <rect x="40" y="160" width="120" height="30" class="filled" stroke-width="1"/>
        <text x="100" y="180" text-anchor="middle">Checksum</text>
        <rect x="160" y="160" width="120" height="30" class="filled" stroke-width="1"/>
        <text x="220" y="180" text-anchor="middle">Urgent Pointer</text>
        <text x="280" y="180" text-anchor="start" class="label">16 bits each</text>

        <!-- Options note -->
        <rect x="40" y="195" width="240" height="20" stroke-width="1" stroke-dasharray="4"/>
        <text x="160" y="209" text-anchor="middle" class="label">Options (variable, if Data Offset > 5)</text>
      </svg>
    </div>

    <pre class="bytes">20 bytes minimum header (Data Offset = 5)
+--------+--------+--------+--------+
|     Source Port |    Dest Port    |  0-3
+--------+--------+--------+--------+
|         Sequence Number           |  4-7
+--------+--------+--------+--------+
|      Acknowledgment Number        |  8-11
+--------+--------+--------+--------+
|Off|Rsv|Flags|   Window Size       | 12-15
+--------+--------+--------+--------+
|     Checksum    |  Urgent Pointer | 16-19
+--------+--------+--------+--------+</pre>
  </section>

  <!-- TCP Flags -->
  <section class="section">
    <h2>Control Flags <span class="spec-label">8 bits</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 420 80" xmlns="http://www.w3.org/2000/svg">
        <!-- Flag boxes -->
        <rect x="10" y="20" width="45" height="30" class="filled" stroke-width="1"/>
        <text x="32" y="40" text-anchor="middle">CWR</text>

        <rect x="60" y="20" width="45" height="30" class="filled" stroke-width="1"/>
        <text x="82" y="40" text-anchor="middle">ECE</text>

        <rect x="110" y="20" width="45" height="30" class="filled" stroke-width="1"/>
        <text x="132" y="40" text-anchor="middle">URG</text>

        <rect x="160" y="20" width="45" height="30" class="filled" stroke-width="1"/>
        <text x="182" y="40" text-anchor="middle">ACK</text>

        <rect x="210" y="20" width="45" height="30" class="filled" stroke-width="1"/>
        <text x="232" y="40" text-anchor="middle">PSH</text>

        <rect x="260" y="20" width="45" height="30" class="filled" stroke-width="1"/>
        <text x="282" y="40" text-anchor="middle">RST</text>

        <rect x="310" y="20" width="45" height="30" class="filled" stroke-width="1"/>
        <text x="332" y="40" text-anchor="middle">SYN</text>

        <rect x="360" y="20" width="45" height="30" class="filled" stroke-width="1"/>
        <text x="382" y="40" text-anchor="middle">FIN</text>

        <!-- Bit positions -->
        <text x="32" y="65" text-anchor="middle" class="label">7</text>
        <text x="82" y="65" text-anchor="middle" class="label">6</text>
        <text x="132" y="65" text-anchor="middle" class="label">5</text>
        <text x="182" y="65" text-anchor="middle" class="label">4</text>
        <text x="232" y="65" text-anchor="middle" class="label">3</text>
        <text x="282" y="65" text-anchor="middle" class="label">2</text>
        <text x="332" y="65" text-anchor="middle" class="label">1</text>
        <text x="382" y="65" text-anchor="middle" class="label">0</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Flag</th><th>Name</th><th>Purpose</th></tr>
      <tr><td><code>SYN</code></td><td>Synchronize</td><td>Initiate connection, synchronize sequence numbers</td></tr>
      <tr><td><code>ACK</code></td><td>Acknowledgment</td><td>Acknowledgment field is valid</td></tr>
      <tr><td><code>FIN</code></td><td>Finish</td><td>No more data from sender, close connection</td></tr>
      <tr><td><code>RST</code></td><td>Reset</td><td>Abort connection immediately</td></tr>
      <tr><td><code>PSH</code></td><td>Push</td><td>Push data to application immediately</td></tr>
      <tr><td><code>URG</code></td><td>Urgent</td><td>Urgent pointer field is valid</td></tr>
      <tr><td><code>ECE</code></td><td>ECN-Echo</td><td>ECN capability or congestion indication</td></tr>
      <tr><td><code>CWR</code></td><td>Congestion Window Reduced</td><td>Sender reduced congestion window</td></tr>
    </table>
  </section>

  <!-- Three-Way Handshake -->
  <section class="section">
    <h2>Three-Way Handshake <span class="spec-label">Connection Establishment</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 400 200" xmlns="http://www.w3.org/2000/svg">
        <!-- Client and Server lines -->
        <text x="60" y="20" text-anchor="middle">Client</text>
        <line x1="60" y1="30" x2="60" y2="190" stroke-width="2"/>

        <text x="340" y="20" text-anchor="middle">Server</text>
        <line x1="340" y1="30" x2="340" y2="190" stroke-width="2"/>

        <!-- Step 1: SYN -->
        <line x1="60" y1="55" x2="340" y2="75" stroke-width="1"/>
        <path d="M 335 70 L 340 75 L 332 77" stroke-width="1"/>
        <text x="200" y="50" text-anchor="middle">SYN, Seq=x</text>
        <text x="200" y="65" text-anchor="middle" class="label">1. Client initiates</text>

        <!-- Step 2: SYN-ACK -->
        <line x1="340" y1="100" x2="60" y2="120" stroke-width="1"/>
        <path d="M 65 115 L 60 120 L 68 122" stroke-width="1"/>
        <text x="200" y="95" text-anchor="middle">SYN+ACK, Seq=y, Ack=x+1</text>
        <text x="200" y="110" text-anchor="middle" class="label">2. Server responds</text>

        <!-- Step 3: ACK -->
        <line x1="60" y1="145" x2="340" y2="165" stroke-width="1"/>
        <path d="M 335 160 L 340 165 L 332 167" stroke-width="1"/>
        <text x="200" y="140" text-anchor="middle">ACK, Seq=x+1, Ack=y+1</text>
        <text x="200" y="155" text-anchor="middle" class="label">3. Connection established</text>

        <!-- States -->
        <text x="60" y="185" text-anchor="middle" class="label">ESTABLISHED</text>
        <text x="340" y="185" text-anchor="middle" class="label">ESTABLISHED</text>
      </svg>
    </div>

    <pre class="bytes">Client                              Server
  |                                    |
  |--- SYN, Seq=1000 ----------------->|  LISTEN
  |                                    |  SYN-RECEIVED
  |<-- SYN+ACK, Seq=2000, Ack=1001 ----|
  |                                    |
  |--- ACK, Seq=1001, Ack=2001 ------->|  ESTABLISHED
  |                                    |
  ESTABLISHED                          |</pre>
  </section>

  <!-- Connection Termination -->
  <section class="section">
    <h2>Connection Termination <span class="spec-label">Four-Way Handshake</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 400 220" xmlns="http://www.w3.org/2000/svg">
        <!-- Client and Server lines -->
        <text x="60" y="20" text-anchor="middle">Client</text>
        <line x1="60" y1="30" x2="60" y2="210" stroke-width="2"/>

        <text x="340" y="20" text-anchor="middle">Server</text>
        <line x1="340" y1="30" x2="340" y2="210" stroke-width="2"/>

        <!-- Step 1: FIN -->
        <line x1="60" y1="50" x2="340" y2="65" stroke-width="1"/>
        <path d="M 335 60 L 340 65 L 332 67" stroke-width="1"/>
        <text x="200" y="45" text-anchor="middle">FIN, Seq=x</text>
        <text x="30" y="50" text-anchor="middle" class="label">FIN-WAIT-1</text>

        <!-- Step 2: ACK -->
        <line x1="340" y1="90" x2="60" y2="105" stroke-width="1"/>
        <path d="M 65 100 L 60 105 L 68 107" stroke-width="1"/>
        <text x="200" y="85" text-anchor="middle">ACK, Ack=x+1</text>
        <text x="30" y="105" text-anchor="middle" class="label">FIN-WAIT-2</text>
        <text x="370" y="90" text-anchor="middle" class="label">CLOSE-WAIT</text>

        <!-- Step 3: FIN -->
        <line x1="340" y1="130" x2="60" y2="145" stroke-width="1"/>
        <path d="M 65 140 L 60 145 L 68 147" stroke-width="1"/>
        <text x="200" y="125" text-anchor="middle">FIN, Seq=y</text>
        <text x="370" y="130" text-anchor="middle" class="label">LAST-ACK</text>

        <!-- Step 4: ACK -->
        <line x1="60" y1="170" x2="340" y2="185" stroke-width="1"/>
        <path d="M 335 180 L 340 185 L 332 187" stroke-width="1"/>
        <text x="200" y="165" text-anchor="middle">ACK, Ack=y+1</text>
        <text x="30" y="170" text-anchor="middle" class="label">TIME-WAIT</text>

        <!-- Final states -->
        <text x="60" y="205" text-anchor="middle" class="label">CLOSED</text>
        <text x="340" y="205" text-anchor="middle" class="label">CLOSED</text>
      </svg>
    </div>
  </section>

  <!-- Connection States -->
  <section class="section">
    <h2>Connection States <span class="spec-label">State Machine</span></h2>

    <table class="defaults-table">
      <tr><th>State</th><th>Description</th></tr>
      <tr><td><code>CLOSED</code></td><td>No connection exists</td></tr>
      <tr><td><code>LISTEN</code></td><td>Server waiting for incoming connections</td></tr>
      <tr><td><code>SYN-SENT</code></td><td>Client sent SYN, waiting for SYN-ACK</td></tr>
      <tr><td><code>SYN-RECEIVED</code></td><td>Server received SYN, sent SYN-ACK, waiting for ACK</td></tr>
      <tr><td><code>ESTABLISHED</code></td><td>Connection open, data transfer in progress</td></tr>
      <tr><td><code>FIN-WAIT-1</code></td><td>Sent FIN, waiting for ACK or FIN</td></tr>
      <tr><td><code>FIN-WAIT-2</code></td><td>Received ACK for FIN, waiting for FIN</td></tr>
      <tr><td><code>CLOSE-WAIT</code></td><td>Received FIN, waiting for application to close</td></tr>
      <tr><td><code>CLOSING</code></td><td>Both sides sent FIN simultaneously</td></tr>
      <tr><td><code>LAST-ACK</code></td><td>Sent FIN after receiving FIN, waiting for ACK</td></tr>
      <tr><td><code>TIME-WAIT</code></td><td>Waiting 2*MSL before closing (ensures ACK received)</td></tr>
    </table>
  </section>

  <!-- Defaults and Parameters -->
  <section class="section">
    <h2>Defaults <span class="spec-label">Common Parameters</span></h2>

    <table class="defaults-table">
      <tr><th>Parameter</th><th>Default</th><th>Notes</th></tr>
      <tr><td><code>MSS</code></td><td>536 bytes</td><td>Maximum Segment Size (default if not negotiated)</td></tr>
      <tr><td><code>MSS (Ethernet)</code></td><td>1460 bytes</td><td>1500 MTU - 20 IP - 20 TCP</td></tr>
      <tr><td><code>Window Size</code></td><td>65535 bytes</td><td>Max without window scaling</td></tr>
      <tr><td><code>Window Scale</code></td><td>0-14</td><td>Multiplier: 2^scale (RFC 7323)</td></tr>
      <tr><td><code>MSL</code></td><td>2 minutes</td><td>Maximum Segment Lifetime</td></tr>
      <tr><td><code>TIME-WAIT</code></td><td>2 * MSL</td><td>Typically 1-4 minutes</td></tr>
      <tr><td><code>Initial RTO</code></td><td>1 second</td><td>Retransmission timeout</td></tr>
      <tr><td><code>keepalive time</code></td><td>2 hours</td><td>Idle time before probe (if enabled)</td></tr>
    </table>
  </section>

  <!-- Well-Known Ports -->
  <section class="section">
    <h2>Well-Known Ports <span class="spec-label">0-1023 Reserved</span></h2>

    <table class="defaults-table">
      <tr><th>Port</th><th>Service</th><th>Description</th></tr>
      <tr><td><code>20</code></td><td>FTP Data</td><td>File Transfer Protocol (data)</td></tr>
      <tr><td><code>21</code></td><td>FTP Control</td><td>File Transfer Protocol (control)</td></tr>
      <tr><td><code>22</code></td><td>SSH</td><td>Secure Shell</td></tr>
      <tr><td><code>23</code></td><td>Telnet</td><td>Unencrypted text communications</td></tr>
      <tr><td><code>25</code></td><td>SMTP</td><td>Simple Mail Transfer Protocol</td></tr>
      <tr><td><code>53</code></td><td>DNS</td><td>Domain Name System (also UDP)</td></tr>
      <tr><td><code>80</code></td><td>HTTP</td><td>Hypertext Transfer Protocol</td></tr>
      <tr><td><code>110</code></td><td>POP3</td><td>Post Office Protocol v3</td></tr>
      <tr><td><code>143</code></td><td>IMAP</td><td>Internet Message Access Protocol</td></tr>
      <tr><td><code>443</code></td><td>HTTPS</td><td>HTTP over TLS/SSL</td></tr>
      <tr><td><code>587</code></td><td>SMTP</td><td>Mail submission (with auth)</td></tr>
      <tr><td><code>993</code></td><td>IMAPS</td><td>IMAP over TLS</td></tr>
      <tr><td><code>3306</code></td><td>MySQL</td><td>MySQL database</td></tr>
      <tr><td><code>5432</code></td><td>PostgreSQL</td><td>PostgreSQL database</td></tr>
    </table>
  </section>

  <!-- TCP Options -->
  <section class="section">
    <h2>Common Options <span class="spec-label">Variable Length</span></h2>

    <table class="defaults-table">
      <tr><th>Kind</th><th>Length</th><th>Option</th><th>Purpose</th></tr>
      <tr><td><code>0</code></td><td>1</td><td>End of Options</td><td>Marks end of options list</td></tr>
      <tr><td><code>1</code></td><td>1</td><td>No-Op</td><td>Padding for alignment</td></tr>
      <tr><td><code>2</code></td><td>4</td><td>MSS</td><td>Maximum Segment Size</td></tr>
      <tr><td><code>3</code></td><td>3</td><td>Window Scale</td><td>Window scaling factor (RFC 7323)</td></tr>
      <tr><td><code>4</code></td><td>2</td><td>SACK Permitted</td><td>Selective ACK allowed</td></tr>
      <tr><td><code>5</code></td><td>var</td><td>SACK</td><td>Selective ACK blocks</td></tr>
      <tr><td><code>8</code></td><td>10</td><td>Timestamps</td><td>RTT measurement, PAWS (RFC 7323)</td></tr>
    </table>
  </section>
</WwwLayout>
