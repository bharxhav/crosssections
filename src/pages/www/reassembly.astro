---
import WwwLayout from "../../layouts/WwwLayout.astro";
---

<WwwLayout title="Packet Reassembly" subtitle="Client-side stream reconstruction â€” from fragments to data" slug="reassembly">
  <!-- TCP Stream Reassembly -->
  <section class="section">
    <h2>TCP Stream Reassembly <span class="spec-label">RFC 9293</span></h2>

    <p>TCP segments may arrive out of order. The client uses sequence numbers to reconstruct the original byte stream.</p>

    <div class="diagram">
      <svg viewBox="0 0 500 200" xmlns="http://www.w3.org/2000/svg">
        <!-- Arriving packets (out of order) -->
        <text x="10" y="15" class="label">arriving packets</text>

        <rect x="10" y="25" width="80" height="35" class="filled" stroke-width="1"/>
        <text x="50" y="47" text-anchor="middle">SEQ 301</text>
        <text x="50" y="70" text-anchor="middle" class="label">3rd</text>

        <rect x="110" y="25" width="80" height="35" class="filled" stroke-width="1"/>
        <text x="150" y="47" text-anchor="middle">SEQ 1</text>
        <text x="150" y="70" text-anchor="middle" class="label">1st</text>

        <rect x="210" y="25" width="80" height="35" class="filled" stroke-width="1"/>
        <text x="250" y="47" text-anchor="middle">SEQ 451</text>
        <text x="250" y="70" text-anchor="middle" class="label">4th</text>

        <rect x="310" y="25" width="80" height="35" class="filled" stroke-width="1"/>
        <text x="350" y="47" text-anchor="middle">SEQ 151</text>
        <text x="350" y="70" text-anchor="middle" class="label">2nd</text>

        <!-- Reordering arrows -->
        <path d="M 250 85 L 250 115" stroke-width="1" stroke-dasharray="3"/>
        <polygon points="245,110 255,110 250,120" fill="currentColor" stroke="none"/>
        <text x="270" y="105" class="label">reorder</text>

        <!-- Reassembled stream -->
        <text x="10" y="145" class="label">reassembled stream</text>

        <rect x="10" y="155" width="100" height="35" class="filled" stroke-width="1"/>
        <text x="60" y="177" text-anchor="middle">1-150</text>

        <rect x="110" y="155" width="100" height="35" class="filled" stroke-width="1"/>
        <text x="160" y="177" text-anchor="middle">151-300</text>

        <rect x="210" y="155" width="100" height="35" class="filled" stroke-width="1"/>
        <text x="260" y="177" text-anchor="middle">301-450</text>

        <rect x="310" y="155" width="100" height="35" class="filled" stroke-width="1"/>
        <text x="360" y="177" text-anchor="middle">451-600</text>

        <!-- Contiguous indicator -->
        <line x1="10" y1="195" x2="410" y2="195" stroke-width="2"/>
        <text x="420" y="198" class="label">contiguous bytes</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Field</th><th>Size</th><th>Purpose</th></tr>
      <tr><td><code>Sequence Number</code></td><td>32 bits</td><td>Byte position in stream</td></tr>
      <tr><td><code>Acknowledgment</code></td><td>32 bits</td><td>Next expected byte</td></tr>
      <tr><td><code>Window Size</code></td><td>16 bits</td><td>Receive buffer space</td></tr>
      <tr><td><code>Checksum</code></td><td>16 bits</td><td>Data integrity</td></tr>
    </table>
  </section>

  <!-- IP Fragment Reassembly -->
  <section class="section">
    <h2>IP Fragment Reassembly <span class="spec-label">RFC 791</span></h2>

    <p>Large IP datagrams are fragmented to fit MTU. The receiver reassembles using identification and fragment offset.</p>

    <div class="diagram">
      <svg viewBox="0 0 480 160" xmlns="http://www.w3.org/2000/svg">
        <!-- Original datagram -->
        <text x="10" y="15" class="label">original datagram (4500 bytes)</text>
        <rect x="10" y="25" width="460" height="30" class="filled" stroke-width="1"/>
        <text x="240" y="45" text-anchor="middle">ID: 0x1234</text>

        <!-- Fragmentation arrows -->
        <path d="M 120 60 L 80 80" stroke-width="1"/>
        <path d="M 240 60 L 240 80" stroke-width="1"/>
        <path d="M 360 60 L 400 80" stroke-width="1"/>

        <!-- Fragments -->
        <text x="10" y="100" class="label">fragments (mtu 1500)</text>

        <rect x="10" y="110" width="140" height="35" class="filled" stroke-width="1"/>
        <text x="80" y="125" text-anchor="middle" font-size="10">ID:0x1234</text>
        <text x="80" y="138" text-anchor="middle" font-size="10">OFF:0 MF:1</text>

        <rect x="170" y="110" width="140" height="35" class="filled" stroke-width="1"/>
        <text x="240" y="125" text-anchor="middle" font-size="10">ID:0x1234</text>
        <text x="240" y="138" text-anchor="middle" font-size="10">OFF:185 MF:1</text>

        <rect x="330" y="110" width="140" height="35" class="filled" stroke-width="1"/>
        <text x="400" y="125" text-anchor="middle" font-size="10">ID:0x1234</text>
        <text x="400" y="138" text-anchor="middle" font-size="10">OFF:370 MF:0</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Field</th><th>Bits</th><th>Description</th></tr>
      <tr><td><code>Identification</code></td><td>16</td><td>Groups fragments together</td></tr>
      <tr><td><code>DF (Don't Fragment)</code></td><td>1</td><td>Fragmentation forbidden</td></tr>
      <tr><td><code>MF (More Fragments)</code></td><td>1</td><td>More fragments follow</td></tr>
      <tr><td><code>Fragment Offset</code></td><td>13</td><td>Position in 8-byte units</td></tr>
    </table>
  </section>

  <!-- TLS Decryption -->
  <section class="section">
    <h2>TLS Decryption <span class="spec-label">RFC 8446</span></h2>

    <p>After TCP reassembly, encrypted TLS records are decrypted using session keys established during handshake.</p>

    <div class="diagram">
      <svg viewBox="0 0 480 140" xmlns="http://www.w3.org/2000/svg">
        <!-- Encrypted record -->
        <text x="10" y="15" class="label">tls record (encrypted)</text>

        <rect x="10" y="25" width="40" height="35" class="filled" stroke-width="1"/>
        <text x="30" y="47" text-anchor="middle">0x17</text>
        <text x="30" y="70" text-anchor="middle" class="label">type</text>

        <rect x="55" y="25" width="50" height="35" class="filled" stroke-width="1"/>
        <text x="80" y="47" text-anchor="middle">0x0303</text>
        <text x="80" y="70" text-anchor="middle" class="label">version</text>

        <rect x="110" y="25" width="45" height="35" class="filled" stroke-width="1"/>
        <text x="132" y="47" text-anchor="middle">len</text>
        <text x="132" y="70" text-anchor="middle" class="label">length</text>

        <rect x="160" y="25" width="310" height="35" class="filled" stroke-width="1"/>
        <text x="315" y="47" text-anchor="middle">encrypted payload + auth tag</text>

        <!-- Decryption arrow -->
        <path d="M 240 70 L 240 95" stroke-width="1"/>
        <polygon points="235,90 245,90 240,100" fill="currentColor" stroke="none"/>
        <text x="255" y="90" class="label">decrypt with session key</text>

        <!-- Decrypted content -->
        <text x="10" y="115" class="label">plaintext</text>
        <rect x="10" y="120" width="460" height="20" class="filled" stroke-width="1"/>
        <text x="240" y="134" text-anchor="middle">HTTP/2 frames or HTTP/1.1 message</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Record Type</th><th>Value</th><th>Content</th></tr>
      <tr><td><code>change_cipher_spec</code></td><td>0x14</td><td>Legacy (TLS 1.2)</td></tr>
      <tr><td><code>alert</code></td><td>0x15</td><td>Error notifications</td></tr>
      <tr><td><code>handshake</code></td><td>0x16</td><td>Key exchange</td></tr>
      <tr><td><code>application_data</code></td><td>0x17</td><td>Encrypted payload</td></tr>
    </table>
  </section>

  <!-- Buffer Management -->
  <section class="section">
    <h2>Buffer Management <span class="spec-label">Receive Buffer</span></h2>

    <p>The receive buffer holds out-of-order segments until gaps are filled and data can be delivered to the application.</p>

    <div class="diagram">
      <svg viewBox="0 0 480 120" xmlns="http://www.w3.org/2000/svg">
        <!-- Buffer visualization -->
        <text x="10" y="15" class="label">receive buffer</text>

        <!-- Buffer slots -->
        <rect x="10" y="25" width="60" height="40" class="filled" stroke-width="1"/>
        <text x="40" y="50" text-anchor="middle">1-100</text>

        <rect x="70" y="25" width="60" height="40" class="filled" stroke-width="1"/>
        <text x="100" y="50" text-anchor="middle">101-200</text>

        <!-- Gap -->
        <rect x="130" y="25" width="60" height="40" stroke-width="1" stroke-dasharray="4"/>
        <text x="160" y="50" text-anchor="middle" opacity="0.4">gap</text>

        <rect x="190" y="25" width="60" height="40" class="filled" stroke-width="1"/>
        <text x="220" y="50" text-anchor="middle">301-400</text>

        <!-- More gaps -->
        <rect x="250" y="25" width="60" height="40" stroke-width="1" stroke-dasharray="4"/>
        <text x="280" y="50" text-anchor="middle" opacity="0.4">gap</text>

        <rect x="310" y="25" width="60" height="40" class="filled" stroke-width="1"/>
        <text x="340" y="50" text-anchor="middle">501-600</text>

        <!-- Free space -->
        <rect x="370" y="25" width="100" height="40" stroke-width="1" stroke-dasharray="2"/>
        <text x="420" y="50" text-anchor="middle" class="label">free</text>

        <!-- Labels -->
        <line x1="10" y1="75" x2="130" y2="75" stroke-width="2"/>
        <text x="70" y="90" text-anchor="middle" class="label">deliverable</text>

        <line x1="130" y1="75" x2="370" y2="75" stroke-width="1" stroke-dasharray="3"/>
        <text x="250" y="90" text-anchor="middle" class="label">waiting for gaps</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Buffer State</th><th>Action</th></tr>
      <tr><td>Contiguous data at head</td><td>Deliver to application</td></tr>
      <tr><td>Out-of-order segment</td><td>Store, wait for missing bytes</td></tr>
      <tr><td>Duplicate segment</td><td>Discard</td></tr>
      <tr><td>Buffer full</td><td>Advertise zero window</td></tr>
    </table>
  </section>

  <!-- Flow Control -->
  <section class="section">
    <h2>Flow Control <span class="spec-label">Sliding Window</span></h2>

    <p>The receiver advertises available buffer space. The sender limits in-flight data to prevent overflow.</p>

    <div class="diagram">
      <svg viewBox="0 0 500 150" xmlns="http://www.w3.org/2000/svg">
        <!-- Sender view -->
        <text x="10" y="15" class="label">sender view</text>

        <!-- Sent and acked -->
        <rect x="10" y="25" width="80" height="30" fill="currentColor" opacity="0.15" stroke="currentColor" stroke-width="1"/>
        <text x="50" y="45" text-anchor="middle" font-size="9">sent + acked</text>

        <!-- Sent not acked -->
        <rect x="90" y="25" width="100" height="30" fill="currentColor" opacity="0.25" stroke="currentColor" stroke-width="1"/>
        <text x="140" y="45" text-anchor="middle" font-size="9">in flight</text>

        <!-- Usable window -->
        <rect x="190" y="25" width="80" height="30" class="filled" stroke-width="1"/>
        <text x="230" y="45" text-anchor="middle" font-size="9">usable</text>

        <!-- Outside window -->
        <rect x="270" y="25" width="120" height="30" stroke-width="1" stroke-dasharray="3"/>
        <text x="330" y="45" text-anchor="middle" font-size="9" opacity="0.5">not sendable</text>

        <!-- Window bracket -->
        <line x1="90" y1="60" x2="90" y2="75" stroke-width="1"/>
        <line x1="90" y1="75" x2="270" y2="75" stroke-width="1"/>
        <line x1="270" y1="60" x2="270" y2="75" stroke-width="1"/>
        <text x="180" y="90" text-anchor="middle" class="label">send window (rwnd)</text>

        <!-- Window update -->
        <path d="M 400 40 L 460 40" stroke-width="1"/>
        <polygon points="455,35 455,45 465,40" fill="currentColor" stroke="none"/>
        <text x="430" y="30" text-anchor="middle" class="label">ack + window</text>

        <!-- Receiver advertises -->
        <text x="10" y="115" class="label">receiver advertises: window = 16384 bytes</text>
        <rect x="10" y="125" width="200" height="20" class="filled" stroke-width="1"/>
        <text x="110" y="139" text-anchor="middle" font-size="9">available buffer</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Parameter</th><th>Typical Value</th><th>Notes</th></tr>
      <tr><td><code>Initial Window</code></td><td>65535 bytes</td><td>Without window scaling</td></tr>
      <tr><td><code>Window Scale</code></td><td>0-14</td><td>Multiplier: 2^scale</td></tr>
      <tr><td><code>Max Window</code></td><td>1 GB</td><td>With scale=14</td></tr>
      <tr><td><code>Zero Window</code></td><td>0</td><td>Receiver buffer full</td></tr>
    </table>
  </section>

  <!-- Congestion Control -->
  <section class="section">
    <h2>Congestion Control <span class="spec-label">RFC 5681</span></h2>

    <p>Slow start probes network capacity by doubling congestion window until loss or threshold.</p>

    <div class="diagram">
      <svg viewBox="0 0 480 180" xmlns="http://www.w3.org/2000/svg">
        <!-- Axes -->
        <line x1="40" y1="150" x2="460" y2="150" stroke-width="1"/>
        <line x1="40" y1="150" x2="40" y2="20" stroke-width="1"/>
        <text x="250" y="170" text-anchor="middle" class="label">time (rtts)</text>
        <text x="15" y="85" text-anchor="middle" class="label" transform="rotate(-90, 15, 85)">cwnd</text>

        <!-- Slow start curve -->
        <path d="M 40 145 L 60 140 L 80 130 L 100 110 L 120 70 L 140 50"
              stroke-width="2" fill="none"/>
        <text x="90" y="40" class="label">slow start</text>

        <!-- ssthresh line -->
        <line x1="40" y1="50" x2="460" y2="50" stroke-width="1" stroke-dasharray="4"/>
        <text x="470" y="53" class="label">ssthresh</text>

        <!-- Congestion avoidance -->
        <path d="M 140 50 L 180 48 L 220 46 L 260 44 L 300 42"
              stroke-width="2" fill="none"/>
        <text x="220" y="35" class="label">congestion avoidance</text>

        <!-- Loss event -->
        <circle cx="300" cy="42" r="4" fill="currentColor"/>
        <text x="310" y="38" class="label">loss</text>

        <!-- Recovery -->
        <path d="M 300 42 L 300 100" stroke-width="1" stroke-dasharray="2"/>
        <path d="M 300 100 L 340 95 L 380 90 L 420 85 L 460 80"
              stroke-width="2" fill="none"/>
        <text x="380" y="75" class="label">recovery</text>

        <!-- RTT markers -->
        <text x="60" y="160" text-anchor="middle" font-size="8">1</text>
        <text x="100" y="160" text-anchor="middle" font-size="8">2</text>
        <text x="140" y="160" text-anchor="middle" font-size="8">3</text>
        <text x="180" y="160" text-anchor="middle" font-size="8">4</text>
      </svg>
    </div>

    <pre class="bytes">Slow Start:     cwnd = cwnd + MSS (per ACK)
Cong. Avoid:    cwnd = cwnd + MSS/cwnd (per ACK)
Fast Recovery:  cwnd = ssthresh + 3*MSS</pre>

    <table class="defaults-table">
      <tr><th>Algorithm</th><th>Trigger</th><th>Action</th></tr>
      <tr><td>Slow Start</td><td><code>cwnd < ssthresh</code></td><td>Double cwnd per RTT</td></tr>
      <tr><td>Congestion Avoidance</td><td><code>cwnd >= ssthresh</code></td><td>Linear increase</td></tr>
      <tr><td>Fast Retransmit</td><td>3 duplicate ACKs</td><td>Retransmit lost segment</td></tr>
      <tr><td>Fast Recovery</td><td>After retransmit</td><td>Halve ssthresh, inflate cwnd</td></tr>
    </table>
  </section>

  <!-- Reassembly Complete -->
  <section class="section">
    <h2>Reassembly Complete <span class="spec-label">Application Delivery</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 480 100" xmlns="http://www.w3.org/2000/svg">
        <!-- Pipeline -->
        <rect x="10" y="35" width="80" height="30" class="filled" stroke-width="1"/>
        <text x="50" y="55" text-anchor="middle" font-size="10">IP Fragments</text>

        <path d="M 95 50 L 115 50" stroke-width="1"/>
        <polygon points="110,45 110,55 120,50" fill="currentColor" stroke="none"/>

        <rect x="125" y="35" width="80" height="30" class="filled" stroke-width="1"/>
        <text x="165" y="55" text-anchor="middle" font-size="10">TCP Stream</text>

        <path d="M 210 50 L 230 50" stroke-width="1"/>
        <polygon points="225,45 225,55 235,50" fill="currentColor" stroke="none"/>

        <rect x="240" y="35" width="80" height="30" class="filled" stroke-width="1"/>
        <text x="280" y="55" text-anchor="middle" font-size="10">TLS Decrypt</text>

        <path d="M 325 50 L 345 50" stroke-width="1"/>
        <polygon points="340,45 340,55 350,50" fill="currentColor" stroke="none"/>

        <rect x="355" y="35" width="115" height="30" class="filled" stroke-width="1"/>
        <text x="412" y="55" text-anchor="middle" font-size="10">Application Data</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Layer</th><th>Reassembly Unit</th><th>Identifier</th></tr>
      <tr><td>IP</td><td>Datagram</td><td>ID + Fragment Offset</td></tr>
      <tr><td>TCP</td><td>Byte Stream</td><td>Sequence Number</td></tr>
      <tr><td>TLS</td><td>Record</td><td>Implicit sequence</td></tr>
      <tr><td>HTTP/2</td><td>Stream</td><td>Stream ID</td></tr>
    </table>
  </section>
</WwwLayout>
