---
import WwwLayout from "../../layouts/WwwLayout.astro";
---

<WwwLayout title="Rendering" subtitle="Browser rendering pipeline â€” from DOM to pixels" slug="rendering">
  <!-- Rendering Pipeline -->
  <section class="section">
    <h2>Rendering Pipeline <span class="spec-label">CSS OM View</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 520 80" xmlns="http://www.w3.org/2000/svg">
        <rect x="0" y="20" width="70" height="35" class="filled" stroke-width="1"/>
        <text x="35" y="43" text-anchor="middle">Style</text>
        <text x="35" y="68" text-anchor="middle" class="label">compute</text>

        <line x1="75" y1="37" x2="105" y2="37" stroke-width="1"/>
        <path d="M100 33 L108 37 L100 41" stroke-width="1"/>

        <rect x="110" y="20" width="80" height="35" class="filled" stroke-width="1"/>
        <text x="150" y="43" text-anchor="middle">Layout</text>
        <text x="150" y="68" text-anchor="middle" class="label">geometry</text>

        <line x1="195" y1="37" x2="225" y2="37" stroke-width="1"/>
        <path d="M220 33 L228 37 L220 41" stroke-width="1"/>

        <rect x="230" y="20" width="70" height="35" class="filled" stroke-width="1"/>
        <text x="265" y="43" text-anchor="middle">Paint</text>
        <text x="265" y="68" text-anchor="middle" class="label">draw</text>

        <line x1="305" y1="37" x2="335" y2="37" stroke-width="1"/>
        <path d="M330 33 L338 37 L330 41" stroke-width="1"/>

        <rect x="340" y="20" width="90" height="35" class="filled" stroke-width="1"/>
        <text x="385" y="43" text-anchor="middle">Composite</text>
        <text x="385" y="68" text-anchor="middle" class="label">GPU</text>

        <line x1="435" y1="37" x2="465" y2="37" stroke-width="1"/>
        <path d="M460 33 L468 37 L460 41" stroke-width="1"/>

        <text x="485" y="43" text-anchor="middle" opacity="0.6">Display</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Stage</th><th>Input</th><th>Output</th></tr>
      <tr><td><code>Style</code></td><td>DOM + CSSOM</td><td>Render tree with computed styles</td></tr>
      <tr><td><code>Layout</code></td><td>Render tree</td><td>Box positions and dimensions</td></tr>
      <tr><td><code>Paint</code></td><td>Layout tree</td><td>Paint records (draw commands)</td></tr>
      <tr><td><code>Composite</code></td><td>Layers</td><td>Final pixels on screen</td></tr>
    </table>
  </section>

  <!-- Layout -->
  <section class="section">
    <h2>Layout <span class="spec-label">Box Model</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 320 220" xmlns="http://www.w3.org/2000/svg">
        <!-- Margin -->
        <rect x="10" y="10" width="300" height="200" class="filled" stroke-width="1" stroke-dasharray="4"/>
        <text x="160" y="25" text-anchor="middle" class="label">margin</text>

        <!-- Border -->
        <rect x="40" y="35" width="240" height="150" class="filled" stroke-width="2"/>
        <text x="160" y="50" text-anchor="middle" class="label">border</text>

        <!-- Padding -->
        <rect x="60" y="55" width="200" height="110" class="filled" stroke-width="1" stroke-dasharray="2"/>
        <text x="160" y="72" text-anchor="middle" class="label">padding</text>

        <!-- Content -->
        <rect x="90" y="85" width="140" height="50" class="filled" stroke-width="1"/>
        <text x="160" y="115" text-anchor="middle">content</text>

        <!-- Dimension annotations -->
        <line x1="90" y1="145" x2="230" y2="145" stroke-width="1" opacity="0.5"/>
        <text x="160" y="160" text-anchor="middle" class="label">width</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Property</th><th>Default</th><th>Affects</th></tr>
      <tr><td><code>box-sizing</code></td><td><code>content-box</code></td><td>width/height calculation</td></tr>
      <tr><td><code>display</code></td><td>element-dependent</td><td>box type (block/inline)</td></tr>
      <tr><td><code>position</code></td><td><code>static</code></td><td>layout flow</td></tr>
      <tr><td><code>width</code></td><td><code>auto</code></td><td>content box width</td></tr>
      <tr><td><code>height</code></td><td><code>auto</code></td><td>content box height</td></tr>
    </table>
  </section>

  <!-- Paint -->
  <section class="section">
    <h2>Paint <span class="spec-label">Drawing Order</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 400 130" xmlns="http://www.w3.org/2000/svg">
        <!-- Stack visualization -->
        <rect x="20" y="100" width="360" height="20" class="filled" stroke-width="1"/>
        <text x="200" y="115" text-anchor="middle">1. Background color</text>

        <rect x="20" y="75" width="360" height="20" class="filled" stroke-width="1"/>
        <text x="200" y="90" text-anchor="middle">2. Background image</text>

        <rect x="20" y="50" width="360" height="20" class="filled" stroke-width="1"/>
        <text x="200" y="65" text-anchor="middle">3. Border</text>

        <rect x="20" y="25" width="360" height="20" class="filled" stroke-width="1"/>
        <text x="200" y="40" text-anchor="middle">4. Children</text>

        <rect x="20" y="0" width="360" height="20" class="filled" stroke-width="1"/>
        <text x="200" y="15" text-anchor="middle">5. Outline</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Property</th><th>Creates Layer</th><th>Triggers Paint</th></tr>
      <tr><td><code>color</code></td><td>No</td><td>Yes</td></tr>
      <tr><td><code>background</code></td><td>No</td><td>Yes</td></tr>
      <tr><td><code>box-shadow</code></td><td>No</td><td>Yes</td></tr>
      <tr><td><code>border-radius</code></td><td>No</td><td>Yes</td></tr>
      <tr><td><code>visibility</code></td><td>No</td><td>Yes</td></tr>
    </table>
  </section>

  <!-- Composite -->
  <section class="section">
    <h2>Composite <span class="spec-label">GPU Layers</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 400 120" xmlns="http://www.w3.org/2000/svg">
        <!-- Layer stack (3D effect) -->
        <rect x="50" y="70" width="150" height="40" class="filled" stroke-width="1"/>
        <text x="125" y="95" text-anchor="middle">Layer 1 (root)</text>

        <rect x="80" y="45" width="150" height="40" class="filled" stroke-width="1"/>
        <text x="155" y="70" text-anchor="middle">Layer 2</text>

        <rect x="110" y="20" width="150" height="40" class="filled" stroke-width="1"/>
        <text x="185" y="45" text-anchor="middle">Layer 3 (GPU)</text>

        <!-- Arrow to GPU -->
        <line x1="280" y1="55" x2="320" y2="55" stroke-width="1"/>
        <path d="M315 51 L323 55 L315 59" stroke-width="1"/>

        <rect x="330" y="40" width="50" height="30" class="filled" stroke-width="1"/>
        <text x="355" y="60" text-anchor="middle">GPU</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Property</th><th>Creates Compositor Layer</th></tr>
      <tr><td><code>transform</code></td><td>Yes (3D or will-change)</td></tr>
      <tr><td><code>opacity</code></td><td>Yes (when animated)</td></tr>
      <tr><td><code>will-change</code></td><td>Yes (hints to browser)</td></tr>
      <tr><td><code>filter</code></td><td>Yes</td></tr>
      <tr><td><code>position: fixed</code></td><td>Yes (in most browsers)</td></tr>
    </table>
  </section>

  <!-- Reflow vs Repaint -->
  <section class="section">
    <h2>Reflow vs Repaint <span class="spec-label">Performance</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 450 100" xmlns="http://www.w3.org/2000/svg">
        <!-- Reflow path -->
        <text x="10" y="30" class="label">REFLOW</text>
        <rect x="60" y="15" width="60" height="25" class="filled" stroke-width="1"/>
        <text x="90" y="32" text-anchor="middle">Layout</text>
        <line x1="125" y1="27" x2="145" y2="27" stroke-width="1"/>
        <path d="M140 23 L148 27 L140 31" stroke-width="1"/>
        <rect x="150" y="15" width="50" height="25" class="filled" stroke-width="1"/>
        <text x="175" y="32" text-anchor="middle">Paint</text>
        <line x1="205" y1="27" x2="225" y2="27" stroke-width="1"/>
        <path d="M220 23 L228 27 L220 31" stroke-width="1"/>
        <rect x="230" y="15" width="70" height="25" class="filled" stroke-width="1"/>
        <text x="265" y="32" text-anchor="middle">Composite</text>

        <!-- Repaint path -->
        <text x="10" y="70" class="label">REPAINT</text>
        <rect x="150" y="55" width="50" height="25" class="filled" stroke-width="1"/>
        <text x="175" y="72" text-anchor="middle">Paint</text>
        <line x1="205" y1="67" x2="225" y2="67" stroke-width="1"/>
        <path d="M220 63 L228 67 L220 71" stroke-width="1"/>
        <rect x="230" y="55" width="70" height="25" class="filled" stroke-width="1"/>
        <text x="265" y="72" text-anchor="middle">Composite</text>

        <!-- Cost indicator -->
        <text x="340" y="32" opacity="0.5">expensive</text>
        <text x="340" y="72" opacity="0.5">moderate</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Trigger</th><th>Reflow</th><th>Repaint</th></tr>
      <tr><td><code>width, height</code></td><td>Yes</td><td>Yes</td></tr>
      <tr><td><code>margin, padding</code></td><td>Yes</td><td>Yes</td></tr>
      <tr><td><code>top, left</code> (positioned)</td><td>Yes</td><td>Yes</td></tr>
      <tr><td><code>font-size</code></td><td>Yes</td><td>Yes</td></tr>
      <tr><td><code>color, background</code></td><td>No</td><td>Yes</td></tr>
      <tr><td><code>transform</code></td><td>No</td><td>No (composite only)</td></tr>
      <tr><td><code>opacity</code></td><td>No</td><td>No (composite only)</td></tr>
    </table>
  </section>

  <!-- GPU Acceleration -->
  <section class="section">
    <h2>GPU Acceleration <span class="spec-label">Composite Only</span></h2>

    <pre class="bytes">{`/* Promote to compositor layer */
.animated {
  will-change: transform;
  transform: translateZ(0);  /* hack */
}

/* Fast properties (composite only) */
transform: translate(x, y);
transform: scale(n);
transform: rotate(deg);
opacity: 0..1;`}</pre>

    <table class="defaults-table">
      <tr><th>Property</th><th>Why Fast</th></tr>
      <tr><td><code>transform</code></td><td>GPU handles matrix math, no reflow</td></tr>
      <tr><td><code>opacity</code></td><td>Alpha blending on GPU, no repaint</td></tr>
      <tr><td><code>filter</code></td><td>GPU shader processing</td></tr>
    </table>
  </section>

  <!-- Frame Budget -->
  <section class="section">
    <h2>Frame Budget <span class="spec-label">60fps Target</span></h2>

    <div class="diagram">
      <svg viewBox="0 0 400 80" xmlns="http://www.w3.org/2000/svg">
        <!-- Frame timeline -->
        <line x1="20" y1="40" x2="380" y2="40" stroke-width="1"/>

        <!-- 16.67ms marks -->
        <line x1="20" y1="35" x2="20" y2="45" stroke-width="2"/>
        <text x="20" y="60" text-anchor="middle" class="label">0ms</text>

        <line x1="200" y1="35" x2="200" y2="45" stroke-width="2"/>
        <text x="200" y="60" text-anchor="middle" class="label">16.67ms</text>

        <line x1="380" y1="35" x2="380" y2="45" stroke-width="2"/>
        <text x="380" y="60" text-anchor="middle" class="label">33.33ms</text>

        <!-- Frame work -->
        <rect x="25" y="25" width="40" height="20" class="filled" stroke-width="1"/>
        <text x="45" y="20" text-anchor="middle" class="label">JS</text>

        <rect x="70" y="25" width="30" height="20" class="filled" stroke-width="1"/>
        <text x="85" y="20" text-anchor="middle" class="label">Style</text>

        <rect x="105" y="25" width="35" height="20" class="filled" stroke-width="1"/>
        <text x="122" y="20" text-anchor="middle" class="label">Layout</text>

        <rect x="145" y="25" width="25" height="20" class="filled" stroke-width="1"/>
        <text x="157" y="20" text-anchor="middle" class="label">Paint</text>

        <rect x="175" y="25" width="20" height="20" class="filled" stroke-width="1"/>
        <text x="185" y="20" text-anchor="middle" class="label">Comp</text>
      </svg>
    </div>

    <table class="defaults-table">
      <tr><th>Target FPS</th><th>Frame Budget</th><th>Practical Budget</th></tr>
      <tr><td>60 fps</td><td>16.67 ms</td><td>~10 ms (browser overhead)</td></tr>
      <tr><td>120 fps</td><td>8.33 ms</td><td>~6 ms</td></tr>
      <tr><td>30 fps</td><td>33.33 ms</td><td>~28 ms</td></tr>
    </table>
  </section>

  <!-- Viewport Defaults -->
  <section class="section">
    <h2>Viewport Defaults <span class="spec-label">CSS Device Adaptation</span></h2>

    <pre class="bytes">&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</pre>

    <table class="defaults-table">
      <tr><th>Property</th><th>Default</th><th>Description</th></tr>
      <tr><td><code>width</code></td><td>980px (mobile)</td><td>Viewport width in pixels or <code>device-width</code></td></tr>
      <tr><td><code>height</code></td><td>auto</td><td>Viewport height</td></tr>
      <tr><td><code>initial-scale</code></td><td>calculated</td><td>Initial zoom level (1.0 = 100%)</td></tr>
      <tr><td><code>minimum-scale</code></td><td>0.1</td><td>Minimum zoom allowed</td></tr>
      <tr><td><code>maximum-scale</code></td><td>10</td><td>Maximum zoom allowed</td></tr>
      <tr><td><code>user-scalable</code></td><td>yes</td><td>Allow pinch-to-zoom</td></tr>
    </table>
  </section>
</WwwLayout>
